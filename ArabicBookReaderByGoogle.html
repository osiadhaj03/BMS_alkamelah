<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุงุฑุฆ ุงููุชุจ ุงูุนุฑุจูุฉ - ุนูุฏุฉ ุงูุฑุนุงูุฉ</title>
    
    <!-- ุชุญููู ุงูุฎุทูุท ุงูุนุฑุจูุฉ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Noto+Kufi+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- ูุชุบูุฑุงุช ุงูุฃููุงู ุงูุฌุฏูุฏุฉ (ูุณุชูุญุงุฉ ูู ุงูุตูุฑ) --- */
        :root {
            /* ุงูููุท ุงูููุงุฑู "ุงูุชุฑุงุซู" */
            --bg-body: #f3f1eb; /* ุจูุฌ ูุงุฏุฆ ููุฎูููุฉ ุงูุนุงูุฉ */
            --bg-paper: #fdfbf7; /* ููู ูุฑู ูุฑููู */
            --bg-sidebar: #fdfbf7;
            
            --text-main: #2b2b2b; /* ุฃุณูุฏ ูุญูู */
            --text-secondary: #666666;
            
            --accent-color: #557c55; /* ุฃุฎุถุฑ ุฒูุชููู (Sage Green) */
            --accent-hover: #416041;
            --accent-light: #e8f0e8; /* ุฎูููุฉ ุฎูููุฉ ููุนูุงุตุฑ ุงููุดุทุฉ */
            
            --border-color: #e0ddd5;
            --highlight-color: #ffeb3b80;
            
            --shadow-soft: 0 10px 30px rgba(85, 124, 85, 0.08); /* ุธู ุฃุฎุถุฑ ุฎููู */
            --shadow-paper: 0 4px 20px rgba(0,0,0,0.06);
            
            --font-main: 'Amiri', serif;
            --font-ui: 'Noto Kufi Arabic', sans-serif;
            
            --radius-main: 16px; /* ุฒูุงูุง ุฏุงุฆุฑูุฉ ูุงุนูุฉ */
        }

        [data-theme="dark"] {
            /* ุงูููุท ุงููููู */
            --bg-body: #1a1b1e;
            --bg-paper: #25262b;
            --bg-sidebar: #202125;
            
            --text-main: #e0e0e0;
            --text-secondary: #909296;
            
            --accent-color: #74b874;
            --accent-hover: #8ce98c;
            --accent-light: #2c3e2c;
            
            --border-color: #2c2e33;
            --highlight-color: #4a4a2e;
            --shadow-soft: 0 10px 30px rgba(0,0,0,0.3);
            --shadow-paper: none;
        }

        /* --- Reset & Base --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-ui);
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background 0.4s ease, color 0.4s ease;
            overflow: hidden; /* App-like feel */
            height: 100vh;
            display: flex;
            
            /* ุฒุฎุฑูุฉ ุฎูููุฉ ุฅุณูุงููุฉ ุฎูููุฉ ุฌุฏุงู ุจุงุณุชุฎุฏุงู CSS Gradient */
            background-image: 
                radial-gradient(var(--border-color) 1px, transparent 1px),
                radial-gradient(var(--border-color) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }

        /* --- ุดุฑูุท ุฌุงูุจู ุตุบูุฑ ููุฃุฏูุงุช (ูุณุงุฑ ุงูุดุงุดุฉ ููุง ูู ุงูุตูุฑุฉ 2) --- */
        /* ููุงุญุธุฉ: ุจูุง ุฃู ุงูุตูุญุฉ RTLุ ูุงููุณุงุฑ ูู ุงูุฌูุฉ "ุงูุจุนูุฏุฉ". ูุฐุง ุงูุดุฑูุท ููุฃููููุงุช ููุท */
        .mini-sidebar {
            width: 60px;
            background: var(--bg-paper);
            border-right: 1px solid var(--border-color); /* ูู ุงูู RTL ูุตุจุญ ูุฐุง ุงูุญุฏ ุนูู ุงููููู */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            gap: 20px;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.02);
        }
        
        .mini-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }
        .mini-icon:hover, .mini-icon.active {
            background-color: var(--accent-light);
            color: var(--accent-color);
        }
        .mini-icon svg { width: 22px; height: 22px; fill: currentColor; }

        /* --- ุงูุญุงููุฉ ุงูุฑุฆูุณูุฉ --- */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: transparent;
        }

        /* --- ุงูููุฏุฑ (ุดุฑูุท ุงูุฃุฏูุงุช) --- */
        header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px;
            z-index: 900;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }
        .header-title h1 {
            font-size: 1.2rem;
            color: var(--text-main);
            font-weight: 700;
        }
        .header-title span {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* ูุฌููุนุฉ ุงูุฃุฒุฑุงุฑ ุงูุนูููุฉ (ููพุณููุฉ) */
        .toolbar-pill {
            background: var(--bg-paper);
            padding: 5px 10px;
            border-radius: 30px; /* ุดูู ูุจุณููุฉ */
            display: flex;
            gap: 5px;
            align-items: center;
            box-shadow: var(--shadow-paper);
            border: 1px solid var(--border-color);
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%; /* ุฏุงุฆุฑู ุจุงููุงูู */
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-ui);
            font-weight: 500;
            font-size: 0.9rem;
        }
        .btn-icon:hover {
            background-color: var(--accent-light);
            color: var(--accent-color);
        }
        .btn-main {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-main:hover {
            background-color: var(--accent-hover);
            color: white;
        }
        .btn-icon svg { width: 20px; height: 20px; fill: currentColor; }


        /* --- ููุทูุฉ ุงูุนูู (Sidebar + Content) --- */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 0 20px 20px 20px; /* ูุณุงูุฉ ุญูู ุงููุฑูุฉ */
            gap: 20px;
        }

        /* --- ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ (ุงูููุฑุณ) --- */
        aside.sidebar {
            width: 300px;
            background-color: var(--bg-paper);
            border-radius: var(--radius-main);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.3s ease, width 0.3s ease;
            box-shadow: var(--shadow-paper);
        }

        .sidebar-header {
            padding: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            background: rgba(0,0,0,0.01);
        }

        .search-wrapper {
            position: relative;
            background: var(--bg-body);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        .search-wrapper input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: none;
            background: transparent;
            color: var(--text-main);
            font-family: var(--font-ui);
            font-size: 0.9rem;
        }
        .search-wrapper .icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .toc-scroll {
            overflow-y: auto;
            flex: 1;
            padding: 10px;
        }
        
        .toc-item {
            margin-bottom: 2px;
        }
        
        .toc-link {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            color: var(--text-main);
            text-decoration: none;
            font-size: 0.9rem;
            border-radius: 8px;
            transition: all 0.2s;
            gap: 10px;
        }
        .toc-link:hover {
            background-color: var(--bg-body);
        }
        .toc-link.active {
            background-color: var(--accent-light);
            color: var(--accent-color);
            font-weight: 600;
        }
        
        .toc-icon {
            width: 18px;
            height: 18px;
            opacity: 0.5;
            flex-shrink: 0;
        }
        .toc-link.active .toc-icon { opacity: 1; fill: var(--accent-color); }

        .toc-sub {
            padding-right: 20px; /* ุฅุฒุงุญุฉ ูููุฑูุน */
            display: none;
            margin-top: 2px;
        }
        .toc-item.expanded .toc-sub { display: block; }

        .chevron {
            margin-right: auto; /* ุฏูุน ุงูุฃููููุฉ ูููุณุงุฑ */
            font-size: 0.7rem;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }
        .toc-item.expanded > .toc-link .chevron { transform: rotate(180deg); }

        /* --- ููุทูุฉ ุงููุฑุงุกุฉ (ุงููุฑูุฉ) --- */
        main.content-area {
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
            border-radius: var(--radius-main);
            /* ุฅุฒุงูุฉ ุงูุฎูููุฉ ููุง ูุฃู ุงููุฑูุฉ ูู ุงูุนูุตุฑ ุงูุฏุงุฎูู */
            display: flex;
            justify-content: center;
        }

        .paper-sheet {
            width: 100%;
            max-width: 900px; /* ุนุฑุถ ูุฑูุญ ูููุฑุงุกุฉ */
            background-color: var(--bg-paper);
            min-height: 100%;
            padding: 60px 80px;
            box-shadow: var(--shadow-paper);
            border-radius: var(--radius-main);
            border: 1px solid var(--border-color);
            transition: background 0.3s;
        }

        .chapter-header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }
        .chapter-header h2 {
            font-family: var(--font-ui);
            font-weight: 700;
            color: var(--accent-color);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        /* ุฒุฎุฑูุฉ ุจุณูุทุฉ ุชุญุช ุงูุนููุงู */
        .chapter-header::after {
            content: "โ";
            display: block;
            color: var(--border-color);
            font-size: 1.5rem;
            margin-top: 15px;
        }

        .chapter-text {
            font-family: var(--font-main);
            line-height: 2.1;
            font-size: 24px; /* ุฎุท ุฃูุจุฑ ููููุงู ููุญุงูุงุฉ ุงูุตูุฑ */
            text-align: justify;
            color: var(--text-main);
        }
        
        .chapter-text p { 
            margin-bottom: 1.8rem; 
            text-indent: 0;
        }
        
        /* ุฃุฑูุงู ุงูุขูุงุช ุฃู ุงูููุฑุงุช (ุฒุฎุฑููุฉ) */
        .verse-end {
            color: var(--accent-color);
            font-size: 0.8em;
            margin: 0 5px;
        }

        .page-pill {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-paper);
            border: 1px solid var(--border-color);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            box-shadow: var(--shadow-soft);
            z-index: 100;
            opacity: 0.9;
        }

        /* --- ุฃุฏูุงุช ุนุงุฆูุฉ --- */
        .highlight {
            background-color: var(--highlight-color);
            border-bottom: 2px solid var(--accent-color);
        }

        /* --- Responsive --- */
        @media (max-width: 950px) {
            .workspace { padding: 0; gap: 0; }
            .paper-sheet { border-radius: 0; border: none; padding: 40px 25px; }
            aside.sidebar {
                position: fixed;
                top: 0; bottom: 0; right: 0;
                z-index: 2000;
                width: 85%;
                max-width: 320px;
                border-radius: 0;
                transform: translateX(100%);
            }
            aside.sidebar.active { transform: translateX(0); }
            
            /* Overlay when sidebar is active */
            .sidebar-overlay {
                position: fixed; inset: 0; background: rgba(0,0,0,0.5);
                z-index: 1900; display: none;
            }
            .sidebar-overlay.active { display: block; }
            
            .mini-sidebar { display: none; } /* ุฅุฎูุงุก ุงูุดุฑูุท ุงูุฑููุน ูู ุงูููุจุงูู */
            #menu-toggle { display: flex !important; }
        }
    </style>
</head>
<body>

    <!-- ุงูุดุฑูุท ุงูุฌุงูุจู ุงูุฑููุน (ุฃููููุงุช ููุท) -->
    <div class="mini-sidebar">
        <div class="mini-icon active" title="ุงููุฑุงุกุฉ">
            <svg viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
        </div>
        <div class="mini-icon" onclick="toggleSidebar()" title="ุงูููุฑุณ">
            <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
        </div>
        <div class="mini-icon" id="btn-bookmark-side" title="ุงููุญููุธุงุช">
            <svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-1.99.9-1.99 2L5 21l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>
        </div>
    </div>

    <div class="app-container">
        <!-- ุงูููุฏุฑ -->
        <header>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button class="btn-icon" id="menu-toggle" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                </button>
                <div class="header-title">
                    <h1>ุนูุฏุฉ ุงูุฑุนุงูุฉ ุนูู ุดุฑุญ ุงูููุงูุฉ</h1>
                    <span>ุงูุฅูุงู ุงูููููู (ุช 747ูู)</span>
                </div>
            </div>

            <!-- ุดุฑูุท ุงูุฃุฏูุงุช ุงูุนุงุฆู -->
            <div class="toolbar-pill">
                <button class="btn-icon" id="btn-search-trigger" title="ุจุญุซ">
                    <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                </button>
                <div style="width: 1px; height: 20px; background: var(--border-color); margin: 0 5px;"></div>
                <button class="btn-icon" id="btn-decrease">A-</button>
                <button class="btn-icon" id="btn-increase">A+</button>
                <button class="btn-icon" id="btn-theme">
                    <svg viewBox="0 0 24 24"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg>
                </button>
                <button class="btn-icon btn-main" id="btn-share" style="border-radius: 20px; padding: 0 15px; width: auto; font-size: 0.8rem;">
                    ูุดุงุฑูุฉ
                </button>
            </div>
        </header>

        <!-- ูุณุงุญุฉ ุงูุนูู -->
        <div class="workspace">
            
            <!-- Overlay for mobile -->
            <div class="sidebar-overlay" id="sidebar-overlay"></div>

            <!-- ุงูููุฑุณ ุงูุฌุงูุจู -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="search-wrapper">
                        <input type="text" id="search-input" placeholder="ุงุจุญุซ ูู ุงูููุฑุณ...">
                        <span class="icon">๐</span>
                    </div>
                </div>
                <div class="toc-scroll">
                    <ul class="toc-list" id="toc-container" style="list-style: none;">
                        <!-- JS Injected TOC -->
                    </ul>
                </div>
            </aside>

            <!-- ูุญุชูู ุงููุฑุงุกุฉ -->
            <main class="content-area" id="content-scroll-area">
                <div id="book-content-wrapper">
                    <!-- ุงูุตูุญุงุช ุณุชุถุงู ููุง -->
                </div>
                
                <!-- ุฑูู ุงูุตูุญุฉ ุงูุนุงุฆู -->
                <div class="page-pill" id="page-indicator">ุงูุตูุญุฉ 1 / 310</div>
            </main>
        </div>
    </div>

    <script>
        // --- 1. ุงูุจูุงูุงุช (ููุณ ุงูุจูุงูุงุช ุงูุณุงุจูุฉ) ---
        const bookData = [
            {
                id: "ch1",
                title: "ููุฏูุฉ ุงููุญูู",
                level: 1,
                content: `
                    <p>ุงูุญูุฏ ููู ุฑุจ ุงูุนุงููููุ ูุงูุตูุงุฉ ูุงูุณูุงู ุนูู ุณูุฏ ุงููุฑุณูููุ ูุนูู ุขูู ูุตุญุจู ุฃุฌูุนูู.</p>
                    <p>ูุฅู ูุชุงุจ "ุดุฑุญ ุงูููุงูุฉ" ูุตุฏุฑ ุงูุดุฑูุนุฉ ุงูุซุงูู ุนุจูุฏ ุงููู ุจู ูุณุนูุฏ (ุงููุชููู ุณูุฉ 747ูู) ูุนุชุจุฑ ูู ุฃูู ุงููุชูู ูู ุงููุฐูุจ ุงูุญูููุ ููุฏ ุงุนุชูู ุจู ุงูุนููุงุก ุดุฑุญุงู ูุชุญุดูุฉ.</p>
                    <p>ููุฏ ุชููุฒ ูุฐุง ุงููุชุงุจ ุจุฏูุฉ ุงูุนุจุงุฑุฉุ ูุญุณู ุงูุชุฑุชูุจุ ูุฌูุน ุงููุณุงุฆู ุงููููุฉ ุงูุชู ูุญุชุงุฌูุง ุงูููุชู ูุงููุงุถู ูุทุงูุจ ุงูุนูู. ููุฐู ุงูุทุจุนุฉ ุงูุชู ุจูู ุฃูุฏููู ุชู ุชุญููููุง ุนูู ุนุฏุฉ ูุณุฎ ุฎุทูุฉ ูููุณุฉุ ููุจูุช ุจุนูุงูุฉ ุชุงูุฉ.</p>
                `,
                subchapters: [
                    { id: "ch1-1", title: "ูููุฌ ุงูุชุญููู", content: "ุงุนุชูุฏูุง ูู ุชุญููู ูุฐุง ุงููุชุงุจ ุงููููุฌ ุงูุนููู ุงููุงุฆู ุนูู ุฌูุน ุงููุณุฎ ูุงูููุงุจูุฉ ุจูููุงุ ูุชุฎุฑูุฌ ุงูุฃุญุงุฏูุซุ ูุงูุชุนููู ุนูู ุงูููุงุถุน ุงููุดููุฉ..." }
                ]
            },
            {
                id: "ch2",
                title: "ูุชุงุจ ุงูุทูุงุฑุฉ",
                level: 1,
                content: `
                    <p>ูุชุงุจ ุงูุทูุงุฑุฉ: ูููู ุจูุงู ุฃููุงุน ุงูููุงูุ ูุงููุถูุกุ ูุงูุบุณูุ ูุงูุชูููุ ูุงููุณุญ ุนูู ุงูุฎููู.</p>
                    <p>ุงุนูู ุฃู ุงูุทูุงุฑุฉ ุดุฑุท ูุตุญุฉ ุงูุตูุงุฉุ ููู ุชููุณู ุฅูู ุทูุงุฑุฉ ูู ุงูุญุฏุซ ูุทูุงุฑุฉ ูู ุงูุฎุจุซ. ูุงูุฃุตู ูู ุงูููุงู ุงูุทูุงุฑุฉ ูุง ูู ูุชุบูุฑ ุฃุญุฏ ุฃูุตุงููุง.</p>
                `,
                subchapters: [
                    {
                        id: "ch2-1",
                        title: "ูุตู ูู ุงููุถูุก",
                        content: `
                            <p>ูุฑุงุฆุถ ุงููุถูุก ุฃุฑุจุนุฉ: ุบุณู ุงููุฌูุ ูุบุณู ุงููุฏูู ูุน ุงููุฑููููุ ููุณุญ ุฑุจุน ุงูุฑุฃุณุ ูุบุณู ุงูุฑุฌููู ูุน ุงููุนุจูู.</p>
                            <p>ูุณููู: ุบุณู ุงููุฏูู ุฅูู ุงูุฑุณุบูู ุซูุงุซุงู ูุจู ุฅุฏุฎุงูููุง ุงูุฅูุงุกุ ูุงูุชุณููุฉ ูู ุงุจุชุฏุงุฆูุ ูุงูุณูุงูุ ูุงููุถูุถุฉุ ูุงูุงุณุชูุดุงูุ ููุณุญ ุงูุฃุฐููู.</p>
                            <p>ูุงู ุฑุณูู ุงููู ุตูู ุงููู ุนููู ูุณูู: (ูุง ุตูุงุฉ ููู ูุง ูุถูุก ููุ ููุง ูุถูุก ููู ูู ูุฐูุฑ ุงุณู ุงููู ุนููู).</p>
                        `
                    },
                    {
                        id: "ch2-2",
                        title: "ูุตู ูู ุงูุบุณู",
                        content: `
                            <p>ููุฌุจุงุช ุงูุบุณู: ุงูุฌูุงุจุฉุ ูุงูุญูุถุ ูุงูููุงุณ. ููุฑุงุฆุถู: ุงููุถูุถุฉุ ูุงูุงุณุชูุดุงูุ ูุบุณู ุณุงุฆุฑ ุงูุจุฏู.</p>
                            <p>ูุณููู: ุฃู ูุจุฏุฃ ุงููุบุชุณู ุจุบุณู ูุฏูู ููุฑุฌูุ ููุฒูู ุงููุฌุงุณุฉ ุฅู ูุงูุช ุนูู ุจุฏููุ ุซู ูุชูุถุฃ ูุถูุกู ููุตูุงุฉ.</p>
                        `
                    }
                ]
            },
            {
                id: "ch3",
                title: "ูุชุงุจ ุงูุตูุงุฉ",
                level: 1,
                content: `
                    <p>ุงูุตูุงุฉ ูู ุนูุงุฏ ุงูุฏููุ ูู ุฃูุงููุง ููุฏ ุฃูุงู ุงูุฏูู. ููู ููุฑูุถุฉ ุจุงููุชุงุจ ูุงูุณูุฉ ูุงูุฅุฌูุงุน.</p>
                    <p>ุฃููุงุช ุงูุตูุงุฉ ุฎูุณุฉ: ุงููุฌุฑุ ูุงูุธูุฑุ ูุงูุนุตุฑุ ูุงููุบุฑุจุ ูุงูุนุดุงุก. ูููู ููุช ุจุฏุงูุฉ ูููุงูุฉ ูุญุฏุฏุฉ ุดุฑุนุงู ูุง ูุฌูุฒ ุชูุฏูููุง ุนูู ููุง ุชุฃุฎูุฑูุง ุฅูุง ูุนุฐุฑ.</p>
                `,
                subchapters: [
                    { id: "ch3-1", title: "ูุตู ูู ุงูุฃููุงุช", content: "<p>ุฃูู ููุช ุงููุฌุฑ ุฅุฐุง ุทูุน ุงููุฌุฑ ุงูุซุงูู ููู ุงูุจูุงุถ ุงููุนุชุฑุถ ูู ุงูุฃูู. ูุฃูู ููุช ุงูุธูุฑ ุฅุฐุง ุฒุงูุช ุงูุดูุณ.</p>" }
                ]
            }
        ];

        let flatChapters = [];
        function flattenBooks(data) {
            data.forEach(chapter => {
                flatChapters.push(chapter);
                if (chapter.subchapters) {
                    chapter.subchapters.forEach(sub => {
                        sub.parentId = chapter.id;
                        flatChapters.push(sub);
                    });
                }
            });
        }
        flattenBooks(bookData);

        const state = {
            loadedCount: 0,
            fontSize: 24,
            theme: 'light',
            isLoading: false
        };

        const dom = {
            toc: document.getElementById('toc-container'),
            wrapper: document.getElementById('book-content-wrapper'),
            scrollArea: document.getElementById('content-scroll-area'),
            sidebar: document.getElementById('sidebar'),
            overlay: document.getElementById('sidebar-overlay'),
            pageInd: document.getElementById('page-indicator')
        };

        function init() {
            renderTOC();
            loadNextChapter(); // Load first
            loadNextChapter(); // Load second
            
            // Events
            dom.scrollArea.addEventListener('scroll', handleScroll);
            document.getElementById('btn-increase').onclick = () => updateFont(2);
            document.getElementById('btn-decrease').onclick = () => updateFont(-2);
            document.getElementById('btn-theme').onclick = toggleTheme;
            document.getElementById('menu-toggle').onclick = toggleSidebar;
            dom.overlay.onclick = toggleSidebar;
            
            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('.toc-item').forEach(item => {
                    const text = item.innerText.toLowerCase();
                    item.style.display = text.includes(term) ? 'block' : 'none';
                });
            });
        }

        // --- Rendering ---
        
        function renderTOC() {
            let html = '';
            bookData.forEach(chapter => {
                const hasSub = chapter.subchapters && chapter.subchapters.length > 0;
                html += `
                    <li class="toc-item ${hasSub ? 'expanded' : ''}" id="toc-${chapter.id}">
                        <a href="#" class="toc-link" onclick="scrollToChapter('${chapter.id}', event)">
                            <svg class="toc-icon" viewBox="0 0 24 24"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z"/></svg>
                            <span>${chapter.title}</span>
                            ${hasSub ? '<span class="chevron">โผ</span>' : ''}
                        </a>
                        ${hasSub ? `<ul class="toc-sub" style="list-style:none;">` : ''}
                `;
                
                if (hasSub) {
                    chapter.subchapters.forEach(sub => {
                        html += `
                            <li class="toc-item" id="toc-${sub.id}">
                                <a href="#" class="toc-link" onclick="scrollToChapter('${sub.id}', event)">
                                    <svg class="toc-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                                    <span>${sub.title}</span>
                                </a>
                            </li>
                        `;
                    });
                    html += `</ul>`;
                }
                html += `</li>`;
            });
            dom.toc.innerHTML = html;
            
            // Toggle Logic
            document.querySelectorAll('.chevron').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    icon.closest('.toc-item').classList.toggle('expanded');
                });
            });
        }

        function loadNextChapter() {
            if (state.isLoading || state.loadedCount >= flatChapters.length) return;
            state.isLoading = true;

            const chapter = flatChapters[state.loadedCount];
            const div = document.createElement('div');
            div.className = 'paper-sheet';
            div.style.marginBottom = "30px"; // Spacing between sheets
            div.id = `chapter-${chapter.id}`;
            
            div.innerHTML = `
                <div class="chapter-header">
                    <h2>${chapter.title}</h2>
                </div>
                <div class="chapter-text" style="font-size: ${state.fontSize}px">
                    ${chapter.content}
                </div>
                <div style="text-align: center; margin-top: 40px; color: var(--text-secondary); font-size: 0.8rem;">
                    
                </div>
            `;

            dom.wrapper.appendChild(div);
            state.loadedCount++;
            state.isLoading = false;
        }

        function handleScroll() {
            const el = dom.scrollArea;
            // Infinite Scroll
            if (el.scrollTop + el.clientHeight >= el.scrollHeight - 200) {
                loadNextChapter();
            }

            // Update Page Number & Active TOC
            const sheets = document.querySelectorAll('.paper-sheet');
            sheets.forEach((sheet, idx) => {
                const rect = sheet.getBoundingClientRect();
                // Check if element is mostly in view
                if (rect.top < window.innerHeight / 2 && rect.bottom > window.innerHeight / 4) {
                    // Update Active TOC
                    document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
                    const activeId = sheet.id.replace('chapter-', '');
                    const link = document.querySelector(`#toc-${activeId} > .toc-link`);
                    if(link) link.classList.add('active');

                    // Update Page Pill
                    dom.pageInd.innerText = `ุงูุตูุญุฉ ${idx + 1} / ${flatChapters.length}`;
                }
            });
        }

        // --- Actions ---

        window.scrollToChapter = function(id, e) {
            e.preventDefault();
            dom.sidebar.classList.remove('active');
            dom.overlay.classList.remove('active');

            let target = document.getElementById(`chapter-${id}`);
            if(!target) {
                // Quick load simulation
                while(state.loadedCount < flatChapters.length) {
                    loadNextChapter();
                    target = document.getElementById(`chapter-${id}`);
                    if(target) break;
                }
            }
            if(target) target.scrollIntoView({behavior: 'smooth'});
        };

        function updateFont(delta) {
            state.fontSize += delta;
            document.querySelectorAll('.chapter-text').forEach(t => t.style.fontSize = state.fontSize + 'px');
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', state.theme);
        }

        function toggleSidebar() {
            dom.sidebar.classList.toggle('active');
            dom.overlay.classList.toggle('active');
        }

        // Init
        init();

    </script>
</body>
</html>