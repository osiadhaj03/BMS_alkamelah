# Database Clone Guide - aaPanel (Direct Method)

Quick guide for cloning large databases in aaPanel using direct pipe method.

---

## Prerequisites

- aaPanel installed and running
- MySQL/MariaDB installed
- SSH/Terminal access
- Source and target database credentials

---

## Step 1: Create New Database in aaPanel

1. **Login to aaPanel**
   - URL: `http://your-server-ip:7800`

2. **Navigate to Database**
   - Click **Database** in left sidebar
   - Click **Add database** button

3. **Create Target Database**
   ```
   Database Name: bms_v2
   Username: bms_v2
   Password: bmsv2
   Access: Local server (127.0.0.1)
   ```

4. **Click Submit**

---

## Step 2: Open Terminal

**In aaPanel:**
- Click **Terminal** in left sidebar

**Or via SSH:**
```bash
ssh root@your-server-ip
```

**Verify MySQL:**
```bash
mysql --version
```

Expected output:
```
mysql Ver 15.1 Distrib 10.11.6-MariaDB
```

---

## Step 3: Clone Database (Direct Method)

**Single Command - Direct Pipe Clone:**

```bash
mysqldump -u bms -pbms2025 --single-transaction --quick --lock-tables=false bms | mysql -u bms_v2 -pbmsv2 bms_v2
```

**Replace with your credentials:**
```bash
mysqldump -u SOURCE_USER -pSOURCE_PASS --single-transaction --quick --lock-tables=false SOURCE_DB | mysql -u TARGET_USER -pTARGET_PASS TARGET_DB
```

**Example Configuration:**
```
Source Database:
- DB_DATABASE=bms
- DB_USERNAME=bms
- DB_PASSWORD=bms2025

Target Database:
- DB_DATABASE=bms_v2
- DB_USERNAME=bms_v2
- DB_PASSWORD=bmsv2
```

---

## Step 4: Use Screen (Prevent Disconnection)

**Start screen session:**
```bash
screen -S dbclone
```

**Run clone command:**
```bash
mysqldump -u bms -pbms2025 --single-transaction --quick --lock-tables=false bms | mysql -u bms_v2 -pbmsv2 bms_v2
```

**Detach from screen:**
- Press: `Ctrl + A`, then press `D`

**Reattach to screen:**
```bash
screen -r dbclone
```

---

## Step 5: Monitor Progress (Optional)

**Open second terminal and run:**

```bash
watch -n 5 'mysql -u bms_v2 -pbmsv2 -e "SELECT table_schema AS \"Database\", ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS \"Size_MB\" FROM information_schema.tables WHERE table_schema IN (\"bms\", \"bms_v2\") GROUP BY table_schema;"'
```

This shows database size growth every 5 seconds.

---

## Step 6: Verify Clone

**Count tables in both databases:**
```bash
mysql -u bms -pbms2025 -e "USE bms; SHOW TABLES;" | wc -l
mysql -u bms_v2 -pbmsv2 -e "USE bms_v2; SHOW TABLES;" | wc -l
```

**Compare database sizes:**
```bash
mysql -u bms_v2 -pbmsv2 -e "SELECT table_schema AS 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size_MB' FROM information_schema.tables WHERE table_schema IN ('bms', 'bms_v2') GROUP BY table_schema;"
```

**Test connection:**
```bash
mysql -u bms_v2 -pbmsv2 bms_v2 -e "SELECT COUNT(*) FROM your_main_table;"
```

---

## Command Breakdown

```bash
mysqldump -u bms -pbms2025 --single-transaction --quick --lock-tables=false bms | mysql -u bms_v2 -pbmsv2 bms_v2
```

**What each part does:**

- `mysqldump`: Export database utility
- `-u bms -pbms2025`: Source database credentials (no space after -p)
- `--single-transaction`: No table locking (for InnoDB tables)
- `--quick`: Stream data without buffering in memory
- `--lock-tables=false`: Prevent table locks during export
- `bms`: Source database name
- `|`: Pipe - sends output directly to next command
- `mysql -u bms_v2 -pbmsv2`: Target database credentials
- `bms_v2`: Target database name

---

## Expected Timeline

For a **20GB database**:
- **Estimated time:** 30-60 minutes
- **No output during process** (this is normal)
- Terminal cursor will just blink
- Don't close terminal window

---

## Troubleshooting

### Issue: Access Denied
```bash
# Grant privileges
mysql -u root -p -e "GRANT ALL PRIVILEGES ON bms_v2.* TO 'bms_v2'@'localhost';"
mysql -u root -p -e "FLUSH PRIVILEGES;"
```

### Issue: Connection Lost
```bash
# Use screen to prevent disconnection
screen -S dbclone
# Run your command
# Detach: Ctrl+A then D
```

### Issue: Disk Space Full
```bash
# Check disk space
df -h

# Find large files
du -sh /www/* | sort -hr | head -10
```

### Issue: Process Stuck
```bash
# Check if running
ps aux | grep mysqldump

# Check MySQL processes
mysqladmin -u root -p processlist
```

---

## Quick Reference

```bash
# Clone database (direct method)
mysqldump -u SOURCE_USER -pSOURCE_PASS --single-transaction --quick --lock-tables=false SOURCE_DB | mysql -u TARGET_USER -pTARGET_PASS TARGET_DB

# With screen protection
screen -S dbclone
mysqldump -u bms -pbms2025 --single-transaction --quick --lock-tables=false bms | mysql -u bms_v2 -pbmsv2 bms_v2

# Monitor progress
watch -n 5 'mysql -u USER -pPASS -e "SELECT table_schema, ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS Size_MB FROM information_schema.tables WHERE table_schema IN (\"source\", \"target\") GROUP BY table_schema;"'

# Verify clone
mysql -u USER -pPASS -e "USE target_db; SHOW TABLES;" | wc -l
```

---

## Why This Method?

✅ **No temporary files** - Direct pipe, no disk space needed  
✅ **Fastest method** - Data streams directly between databases  
✅ **No export/import steps** - Single command does everything  
✅ **Works with large databases** - Handles 20GB+ without issues  
✅ **Safe for production** - `--single-transaction` prevents locks  

---

**Document Version:** 1.0  
**Last Updated:** November 2025